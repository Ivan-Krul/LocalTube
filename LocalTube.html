<!DOCTYPE html>
<html>

<head>
    <title>LocalTube</title>
    <meta charset="utf-8">
    <link rel="icon" href="./favicon.svg">
</head>

<style>
    /*main*/
    body {
        background-color: #101010;
        color: #ffffff
    }

    .text {
        font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
    }

    /*logo*/
    #logo_container {
        background-color: #ff4444;
        color: white;

        margin-bottom: 0px;
        margin-top: 0px;
        padding-bottom: 10px;
        padding-top: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #logo_image {
        width: 2.5vw;
        height: 2.5vw;
    }

    #logo_title {
        font-size: 2.5vw;
        font-weight: bold;
        padding-right: 1vw;
    }

    /*controllers*/
    .controller {
        text-align: center;
    }

    .controller * {
        font-size: 1vw;
    }

    #numberCounterMaxRows {
        max-width: 4vw;
    }

    #searchImage {
        height: 1vw;
        width: 1vw;
    }

    #searchFilter {
        width: 48ch;
    }

    /*video*/
    #video_container {
        text-align: center;
    }

    #video_player {
        max-width: 95%;
        max-height: 75%;
        width: 95vw;
        height: 75vh;
        border: 5px solid black;

        background-color: black;
    }

    #video_title {
        font-size: 2vw;
    }

    .title_preview {
        margin-bottom: 0px;
        margin-top: 0px;
        font-size: 0.9vw;
    }

    .video_title {
        margin-top: 0px;
        margin-bottom: 0px;
    }

    .star-rating {
        font-size: 0;
    }

    .star {
        display: inline-block;

        width: 3vh;
        height: 3vh;

        cursor: pointer;
        background-image: url('empty_star.svg');
        background-size: cover;
    }

    .star.active {
        background-image: url('filled_star.svg');
        /* Replace with your filled star image */
    }

    /*recommendation*/
    #recommend_container {
        text-align: center;
    }

    .preview {
        width: 25vw;
        height: 20vh;
        max-width: 100%;
        max-height: 80%;
        background-size: cover;
        background-position: center;
    }

    .preview_container {
        text-align: center;
        width: 25vw;
        height: 25vh;

        max-width: 25%;
        max-height: 25%;

        border: 5px solid #161616;
        background-color: #161616;
    }

    .preview_container:hover {
        background-color: #303030;
    }

    /*drag & drop user data container*/
    #drop_container {
        text-align: center;
        margin-top: 10px;
        padding: 10px;
        padding-top: 20px;
        padding-bottom: 20px;

        background-color: #161616;
        border: 5px solid #161616;
    }

    /*bottom controller*/
</style>

<body>
    <div id="logo_container">
        <span class="text" id="logo_title">LocalTube</span>
        <img src="./favicon.svg" alt="" id="logo_image">
    </div>
    <div id="controller" class="controller">
        <button id="buttonBack">Back</button>
        <button id="buttonNext">Next</button>
        <button id="buttonShuffler">Shuffle</button>
        <label for="numberCounterMaxRows" class="text">Max rows of recommendation:</label>
        <input type="number" id="numberCounterMaxRows" value="10" min="0" max="99">
        <label for="searchFilter" class="text">Filter:</label>
        <input type="search" id="searchFilter" list="datalistSearchSuggestion" maxlength="128" required>
        <datalist id="datalistSearchSuggestion">
        </datalist>
        <button id="buttonSearch"><img src="./search.svg" id="searchImage"></button>
        <label class="text">Matched results:</label>
        <label id="countFilterResults" class="text"></label>
        <button id="buttonUseProfile" onclick="scrollToBottom()">Use custom user data</button>
    </div>

    <div id="video_container">
        <video src="" controls id="video_player"></video>
        </br>
        <h1 for="video" class="text video_title" id="video_title"></h1>
        <h4 class="text video_title" >Watch counter: <div id="watch_counter"></div></h4>
        <div class="star-rating">
            <span class="star" data-rating="1"></span>
            <span class="star" data-rating="2"></span>
            <span class="star" data-rating="3"></span>
            <span class="star" data-rating="4"></span>
            <span class="star" data-rating="5"></span>
        </div>
    </div>

    <table id="recommend_container">

    </table>

    <div id="bottom_controller_container" class="controller">
        <div id="drop_container">
            <div id="dropTarget" class="text">Drag & Drop user data here</div>
        </div>
        <button id="buttonReserUserData">Reset user data</button>
        <button id="downloadButton">Download user data</button>
        <input type="checkbox" id="buttonToggleHistory">Toggle History</button>
        <label for="history" id="historyCounter"></label>
        <div id="history">

        </div>
    </div>

</body>

<script>
    // main tools
    function getRandomInt(max) {
        return Math.floor(Math.random() * max);
    }

    function readFromFileURL(fileURL) {
        return new Promise((resolve, reject) => {
            fetch(fileURL)
                .then(response => response.blob())
                .then(blob => {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const text = event.target.result;
                        resolve(text);
                    };
                    reader.onerror = function (event) {
                        console.error("Error reading file:", event.target.error);
                        reject(event.target.error);
                    };
                    reader.readAsText(blob);
                })
                .catch(error => {
                    console.error("Error:", error);
                    reject(error);
                });
        });
    }

    function convertLinkToName(link = "") {
        let split = link.split("\\");
        const filename = split[split.length - 1];
        const dots = filename.split(".");
        let name = "";
        for (let i = 0; i < dots.length - 1; i++) {
            name += dots[i];
        }
        return name;
    }

    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: "smooth"
        });
    }

    function scrollToBottom() {
        window.scrollTo({
            top: document.body.scrollHeight,
            behavior: "smooth"
        });
    }

    // globals
    var isRecommendOptionHandled = false;
    var videos = [];
    var filteredVideos = [];
    var videoIndex = 0;
    var recommendList = [];
    var selectedVideo = "";
    var listedNamesOfVideos = [];
    var indexes = 0;
    let history = [];
    var historyIndex = -1;

    // filter
    function filterVideos() {
        let matchString = document.getElementById("searchFilter").value;
        filteredVideos = videos.filter(function (element) {
            return element.indexOf(matchString) !== -1;
        });

        console.log(matchString + ": " + filteredVideos.length);
        let matchedCounter = document.getElementById("countFilterResults");
        matchedCounter.innerText = filteredVideos.length;
    }

    // generator
    function setLinkToVideoContainer(link = "") {
        console.log(link);
        selectedVideo = link;
        let data = JSON.parse(localStorage.getItem("userProfile")).video_rating.find(item => item.video_src === convertLinkToName(selectedVideo));
        if (data) {
            removeActiveStars();
            markActiveStars(data.rating, false);
        }
        else {
            removeActiveStars();
        }

        let videoContainer = document.getElementById("video_container");
        let video = document.getElementById("video_player");
        let label = document.getElementById("video_title");

        video.src = link;

        if ((history.length === historyIndex + 1) && (history[historyIndex] !== link)) {
            history.push(link);
            historyIndex++;
        }
        else {
            if(history[historyIndex] !== link) {
                history.splice(historyIndex+1, history.length - historyIndex);
                history.push(link);
                historyIndex++;
            }
        }

        label.innerText = convertLinkToName(link);
    }

    function generateSinglePreview() {
        let previewContainer = document.createElement("th");

        let video = document.createElement("video");
        video.currentTime = getRandomInt(0, 5);

        let videoIndexBuffer = getRandomInt(filteredVideos.length);
        video.src = filteredVideos[videoIndexBuffer];
        video.className = "preview";
        let label = document.createElement("h4");
        label.className = "text title_preview";
        label.innerText = convertLinkToName(filteredVideos[videoIndexBuffer]);
        previewContainer.className = "preview_container";

        listedNamesOfVideos.push(filteredVideos[videoIndexBuffer]);

        video.onclick = handlePreviewVideo;
        label.onclick = handlePreviewLabel;

        previewContainer.appendChild(video);
        previewContainer.appendChild(label);
        previewContainer.onclick = handlePreview;
        previewContainer.value = indexes;

        return previewContainer;
    }

    function generateUniqueSingeRecommends() {
        console.log("Unique");
        let previewContainer = document.createElement("th");

        let video = document.createElement("video");
        video.currentTime = getRandomInt(0, 5);

        if (recommendList.length !== 0) {
            video.src = recommendList[0];
            video.className = "preview";
            let label = document.createElement("h4");
            label.className = "text title_preview";
            label.innerText = convertLinkToName(recommendList[0]);
            previewContainer.className = "preview_container";

            listedNamesOfVideos.push(recommendList[0]);

            recommendList.splice(0, 1);

            video.onclick = handlePreviewVideo;
            label.onclick = handlePreviewLabel;

            previewContainer.appendChild(video);
            previewContainer.appendChild(label);
            previewContainer.onclick = handlePreview;
            previewContainer.value = indexes;
        }

        return previewContainer;
    }

    function generateRecommends() {
        indexes = 0;
        listedNamesOfVideos = [];
        const max_width = 4;

        filterVideos();
        let recommendContainer = document.getElementById("recommend_container");
        let maxRows = document.getElementById("numberCounterMaxRows").value;

        let rec = filteredVideos.length / 4;
        if (filteredVideos.length === 1)
            rec = 0;
        if (rec > maxRows) {
            rec = maxRows;
            recommendList = [];
        }
        else
            recommendList = filteredVideos;

        for (let y = 0; y < rec; y++) {
            let previewRowContainer = document.createElement("tr");
            for (let x = 0; x < max_width; x++) {
                if (recommendList.length !== 0)
                    recommendContainer.appendChild(generateUniqueSingeRecommends());
                else
                    recommendContainer.appendChild(generateSinglePreview());
                indexes++;
            }
            recommendContainer.appendChild(previewRowContainer);
        }
    }

    function getProfile() {
        return JSON.parse(localStorage.getItem("userProfile"));
    }

    // handlers
    function handleClickShuffle() {
        videoIndex = getRandomInt(filteredVideos.length);
        setLinkToVideoContainer(filteredVideos[videoIndex]);
        let table = document.getElementById("recommend_container");

        table.innerHTML = "";
        generateRecommends();
    }

    function handlePreview(event) {
        if (isRecommendOptionHandled) {
            isRecommendOptionHandled = false;
            return;
        }
        handlePreviewActually(event.target)
    }

    function handlePreviewActually(target) {
        setLinkToVideoContainer(listedNamesOfVideos[target.value]);
        scrollToTop();
    }

    function handlePreviewVideo(event) {
        isRecommendOptionHandled = true;
        handlePreviewActually(event.target.parentNode)
    }

    function handlePreviewLabel(event) {
        isRecommendOptionHandled = true;
        handlePreviewActually(event.target.parentNode)
    }

    function handleNumberChanges() {
        let maxRows = document.getElementById("numberCounterMaxRows").value;

        let recommendContainer = document.getElementById("recommend_container");
        recommendContainer.innerHTML = "";
        generateRecommends();
    }

    function handleOptionClick(event) {
        console.log(event);
        setLinkToVideoContainer(event.target.value);
    }

    function removeActiveStars() {
        document.querySelectorAll('.star').forEach((star) => {
            star.classList.remove('active');
        });
    }

    function pushNewVideoRating(rating) {
        let obj = JSON.parse(localStorage.getItem("userProfile"));
        obj.video_rating.push(
            {
                video_src: convertLinkToName(selectedVideo),
                rating: rating,
                count: 1
            }
        );
        localStorage.setItem("userProfile", JSON.stringify(obj));
    }

    function markActiveStars(rating, write = false) {
        let obj = JSON.parse(localStorage.getItem("userProfile"));
        const arr = obj.video_rating.filter(rating => rating.video_src === convertLinkToName(selectedVideo));

        if (arr.length === 0) {
            pushNewVideoRating(rating);
            console.log(rating);
            for (let i = 0; i < rating; i++) {
                document.querySelectorAll('.star')[i].classList.add('active');
            }
            return
        }
        else {
            arr[0].rating = rating;
            if(arr[0].count === undefined)
                arr[0].count = 2;
            localStorage.setItem("userProfile", JSON.stringify(obj));
            console.log(rating);
            for (let i = 0; i < rating; i++) {
                document.querySelectorAll('.star')[i].classList.add('active');
            }
            

        }
    }

    function showHistoryInfo() {
        const historyList = document.getElementById("history");
        document.getElementById("historyCounter").innerText = "History: " + (historyIndex + 1);
        historyList.innerHTML = "";

        history.forEach(element => {
            const newDiv = document.createElement("div");
            newDiv.innerText = element;
            historyList.appendChild(newDiv);
        });
    }

    // event listener
    document.getElementById("buttonShuffler").onclick = handleClickShuffle;
    document.getElementById("numberCounterMaxRows").onclick = handleNumberChanges;
    document.getElementById("buttonSearch").onclick = () => {
        filterVideos();
        document.getElementById("recommend_container").innerHTML = "";
        generateRecommends();
    }
    document.getElementById("searchFilter").addEventListener("input", () => {
        filterVideos();
        let datalistSearchSuggestion = document.getElementById("datalistSearchSuggestion");
        datalistSearchSuggestion.innerHTML = "";

        let len = filteredVideos.length;
        if (filteredVideos.length > document.getElementById("numberCounterMaxRows").value)
            len = document.getElementById("numberCounterMaxRows").value;

        for (let i = 0; i < len; i++) {
            let option = document.createElement("option");
            option.value = convertLinkToName(filteredVideos[i]);
            option.innerText = filteredVideos[i];

            datalistSearchSuggestion.appendChild(option);
        }
    });
    document.getElementById("downloadButton").addEventListener("click", () => {
        // Convert the JSON object to a JSON string
        const jsonString = JSON.stringify(JSON.parse(localStorage.getItem("userProfile")), null, 2); // The second argument (null) is for replacer function, and the third argument (2) is for pretty formatting (optional).

        // Create a Blob containing the JSON data
        const blob = new Blob([jsonString], { type: "application/json" });

        // Create a download link for the Blob
        const downloadLink = document.createElement("a");
        downloadLink.href = window.URL.createObjectURL(blob);
        downloadLink.download = "user_data.json"; // Specify the downloaded file name

        // Trigger a click event on the download link to start the download
        downloadLink.click();
    });
    document.getElementById("buttonReserUserData").addEventListener('click', (event) => {
        console.log("reseted");
        localStorage.setItem("userProfile", JSON.stringify({ "video_rating": [] }));
    });
    dropTarget.addEventListener('dragover', (event) => {
        event.preventDefault(); // Prevent default behavior
    });
    dropTarget.addEventListener('drop', (event) => {
        event.preventDefault(); // Prevent default behavior

        // Get the dropped files
        const files = event.dataTransfer.files;

        // Check if any files were dropped
        if (files.length > 0) {
            const file = files[0]; // Assuming only one file is dropped
            const reader = new FileReader();

            reader.onload = (e) => {
                const content = e.target.result;

                try {
                    const jsonData = JSON.parse(content);

                    // Handle the parsed JSON data here
                    localStorage.setItem("userProfile", JSON.stringify(jsonData));

                    console.log("Loaded");
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                }
            };

            reader.readAsText(file);
        }
    });
    document.getElementById("buttonBack").addEventListener('click', (event) => {
        if (historyIndex >= 1) {
            historyIndex --;
            setLinkToVideoContainer(history[historyIndex]);
        }
    });

    document.getElementById("buttonNext").addEventListener('click', (event) => {
        if (historyIndex + 1 < history.length) {
            historyIndex++;
            setLinkToVideoContainer(history[historyIndex]);
        }
    });
    document.getElementById("buttonToggleHistory").addEventListener('click', (event) => {
        if(document.getElementById("buttonToggleHistory").checked)
            showHistoryInfo();
        else {
            document.getElementById("historyCounter").innerHTML = "";
            document.getElementById("history").innerHTML = "";
        }
    });

    // end
    (async () => {
        if (localStorage.getItem("userProfile") === null)
            localStorage.setItem("userProfile", JSON.stringify({ "video_rating": [], "history": [] }));

        const videoList = await readFromFileURL("content.txt");
        videos = videoList.split("\n");
        videoIndex = getRandomInt(videos.length)
        setLinkToVideoContainer(videos[videoIndex]);
        generateRecommends();
        filterVideos();

        document.querySelectorAll('.star').forEach((star) => {
            star.addEventListener('click', (e) => {
                const rating = e.target.getAttribute('data-rating');
                removeActiveStars();
                markActiveStars(rating, true);
            });
        });
    })();
</script>

</html>